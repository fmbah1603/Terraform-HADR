snapshotId=$(az snapshot list --query "[?properties.managedBy.contains('$resourceGroupName') && properties.managedBy.contains('$vmName')].id | [0]" -o tsv)

snapshotName=$(az snapshot list --query "[?properties.managedBy.contains('$resourceGroupName') && properties.managedBy.contains('$vmName')].name | [0]" -o tsv)

nicName="${virtualMachineName,,}_nic"

# Create NIC in the first subnet of the virtual network
az network nic create \
    --name $nicName \
    --resource-group $resourceGroupName \
    --location $snapshotLocation \
    --subnet $(az network vnet subnet show --name default --vnet-name $virtualNetworkName --resource-group $resourceGroupName --query id --output tsv) \
    --public-ip-address $publicIpId



az : ERROR: (InvalidResourceReference) Resource 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet referenced by 
resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make sure that the 
referenced resource exists, and that both resources are in the same region.
At line:1 char:8
+ $nic = az network nic create --resource-group $resourceGroupName --na ...
+        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (ERROR: (Invalid...he same region.:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
Code: InvalidResourceReference
Message: Resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet 
referenced by resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make 
sure that the referenced resource exists, and that both resources are in the same region.

az network public-ip create --resource-group myResourceGroup --name myPublicIP --sku Standard --version IPv4 --zone 1 2 3
az network nic create --resource-group myResourceGroup --name myNIC --private-ip-address-version IPv4 --vnet-name myVNet --subnet myBackEndSubnet --public-ip-address myPublicIP



az : DEBUG: cli.knack.cli: Command arguments: ['network', 'nic', 'create', '--resource-group', 'az-ha-dev-usva-rg', '--vnet-name', 'az-opa-dev-usva-vnet', '--name', 'hadr-nic', '--subnet', 
'AppSubnet', '--private-ip-address-version', 'IPv4', '--public-ip-address', 'hadr_ip', '--location', 'usgovvirginia', '--debug']
At line:1 char:8
+ $nic = az network nic create --resource-group $resourceGroupName --vn ...
+        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (DEBUG: cli.knac...ia', '--debug']:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
DEBUG: cli.knack.cli: __init__ debug log:
Cannot enable color.
DEBUG: cli.knack.cli: Event: Cli.PreExecute []
DEBUG: cli.knack.cli: Event: CommandParser.OnGlobalArgumentsCreate [<function CLILogging.on_global_arguments at 0x0232D9D8>, <function OutputProducer.on_global_arguments at 0x02655AC8>, 
<function CLIQuery.on_global_arguments at 0x02677898>]
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPreCommandTableCreate []
DEBUG: cli.azure.cli.core: Modules found from index for 'network': ['azure.cli.command_modules.network', 'azure.cli.command_modules.privatedns']
DEBUG: cli.azure.cli.core: Loading command modules:
DEBUG: cli.azure.cli.core: Name                  Load Time    Groups  Commands
DEBUG: cli.azure.cli.core: network                   1.329       115       458
DEBUG: cli.azure.cli.core: privatedns                0.077        14        60
DEBUG: cli.azure.cli.core: Total (2)                 1.405       129       518
DEBUG: cli.azure.cli.core: Loaded 128 groups, 518 commands.
DEBUG: cli.azure.cli.core: Found a match in the command table.
DEBUG: cli.azure.cli.core: Raw command  : network nic create
DEBUG: cli.azure.cli.core: Command table: network nic create
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPreCommandTableTruncate [<function AzCliLogging.init_command_file_logging at 0x04753758>]
DEBUG: cli.azure.cli.core.azlogging: metadata file logging enabled - writing logs to 'C:\Users\fongwaacha\.azure\commands\2024-04-16.01-39-21.network_nic_create.17268.log'.
INFO: az_command_data_logger: command args: network nic create --resource-group {} --vnet-name {} --name {} --subnet {} --private-ip-address-version {} --public-ip-address {} --location {} 
--debug
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPreArgumentLoad [<function register_global_subscription_argument.<locals>.add_subscription_parameter at 0x04768398>]
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPostArgumentLoad []
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPostCommandTableCreate [<function register_ids_argument.<locals>.add_ids_arguments at 0x04780898>, <function 
register_cache_arguments.<locals>.add_cache_arguments at 0x0478FA78>]
DEBUG: cli.knack.cli: Event: CommandInvoker.OnCommandTableLoaded []
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPreParseArgs []
DEBUG: cli.knack.cli: Event: CommandInvoker.OnPostParseArgs [<function OutputProducer.handle_output_argument at 0x02655B18>, <function CLIQuery.handle_query_parameter at 0x026778E8>, 
<function register_ids_argument.<locals>.parse_ids_arguments at 0x0478FA28>]
DEBUG: cli.azure.cli.core.auth.persistence: build_persistence: location='C:\\Users\\fongwaacha\\.azure\\msal_token_cache.bin', encrypt=True
DEBUG: cli.azure.cli.core.auth.binary_cache: load: C:\Users\fongwaacha\.azure\msal_http_cache.bin
DEBUG: urllib3.util.retry: Converted retries value: 1 -> Retry(total=1, connect=None, read=None, redirect=None, status=None)
DEBUG: msal.authority: openid_config = {'token_endpoint': 'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/oauth2/v2.0/token', 'token_endpoint_auth_methods_supported': 
['client_secret_post', 'private_key_jwt', 'client_secret_basic'], 'jwks_uri': 'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/discovery/v2.0/keys', 
'response_modes_supported': ['query', 'fragment', 'form_post'], 'subject_types_supported': ['pairwise'], 'id_token_signing_alg_values_supported': ['RS256'], 'response_types_supported': 
['code', 'id_token', 'code id_token', 'id_token token'], 'scopes_supported': ['openid', 'profile', 'email', 'offline_access'], 'issuer': 
'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/v2.0', 'request_uri_parameter_supported': False, 'userinfo_endpoint': 'https://graph.microsoft.us/oidc/userinfo', 
'authorization_endpoint': 'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/oauth2/v2.0/authorize', 'device_authorization_endpoint': 
'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/oauth2/v2.0/devicecode', 'http_logout_supported': True, 'frontchannel_logout_supported': True, 'end_session_endpoint': 
'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/oauth2/v2.0/logout', 'claims_supported': ['sub', 'iss', 'cloud_instance_name', 'cloud_instance_host_name', 
'cloud_graph_host_name', 'msgraph_host', 'aud', 'exp', 'iat', 'auth_time', 'acr', 'nonce', 'preferred_username', 'name', 'tid', 'ver', 'at_hash', 'c_hash', 'email'], 'kerberos_endpoint': 
'https://login.microsoftonline.us/a907e7eb-c591-42de-a930-6f76ac5fe284/kerberos', 'tenant_region_scope': 'USGov', 'cloud_instance_name': 'microsoftonline.us', 'cloud_graph_host_name': 
'graph.microsoftazure.us', 'msgraph_host': 'graph.microsoft.us', 'rbac_url': 'https://pasff.usgovcloudapi.net'}
DEBUG: msal.application: Broker enabled? None
DEBUG: cli.azure.cli.core.auth.credential_adaptor: CredentialAdaptor.get_token: scopes=('https://management.core.usgovcloudapi.net//.default',), kwargs={}
DEBUG: cli.azure.cli.core.auth.msal_authentication: UserCredential.get_token: scopes=('https://management.core.usgovcloudapi.net//.default',), claims=None, kwargs={}
DEBUG: msal.application: Cache hit an AT
DEBUG: msal.telemetry: Generate or reuse correlation_id: cd5e4d56-aae0-4561-8781-a6bb728ccbbf
DEBUG: cli.azure.cli.core.sdk.policies: Request URL: 'https://management.usgovcloudapi.net/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Micro
soft.Network/networkInterfaces/hadr-nic?api-version=2022-11-01'
DEBUG: cli.azure.cli.core.sdk.policies: Request method: 'PUT'
DEBUG: cli.azure.cli.core.sdk.policies: Request headers:
DEBUG: cli.azure.cli.core.sdk.policies:     'Content-Type': 'application/json'
DEBUG: cli.azure.cli.core.sdk.policies:     'Accept': 'application/json'
DEBUG: cli.azure.cli.core.sdk.policies:     'Content-Length': '539'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-client-request-id': 'ac2aef04-fbb3-11ee-83d9-7c7635f63ea6'
DEBUG: cli.azure.cli.core.sdk.policies:     'CommandName': 'network nic create'
DEBUG: cli.azure.cli.core.sdk.policies:     'ParameterSetName': '--resource-group --vnet-name --name --subnet --private-ip-address-version --public-ip-address --location --debug'
DEBUG: cli.azure.cli.core.sdk.policies:     'User-Agent': 'AZURECLI/2.59.0 (MSI) azsdk-python-core/1.28.0 Python/3.11.8 (Windows-10-10.0.19044-SP0)'
DEBUG: cli.azure.cli.core.sdk.policies:     'Authorization': '*****'
DEBUG: cli.azure.cli.core.sdk.policies: Request body:
DEBUG: cli.azure.cli.core.sdk.policies: {"location": "usgovvirginia", "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAddressVersion": "IPv4", 
"privateIPAllocationMethod": "Dynamic", "publicIPAddress": {"id": 
"/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/publicIPAddresses/hadr_ip"}, "subnet": {"id": 
"/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet"}}}]}}
DEBUG: urllib3.connectionpool: Starting new HTTPS connection (1): management.usgovcloudapi.net:443
DEBUG: urllib3.connectionpool: https://management.usgovcloudapi.net:443 "PUT 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic?api-version=2022-11-01 HTTP/1.1" 400 527
DEBUG: cli.azure.cli.core.sdk.policies: Response status: 400
DEBUG: cli.azure.cli.core.sdk.policies: Response headers:
DEBUG: cli.azure.cli.core.sdk.policies:     'Cache-Control': 'no-cache'
DEBUG: cli.azure.cli.core.sdk.policies:     'Pragma': 'no-cache'
DEBUG: cli.azure.cli.core.sdk.policies:     'Content-Length': '527'
DEBUG: cli.azure.cli.core.sdk.policies:     'Content-Type': 'application/json; charset=utf-8'
DEBUG: cli.azure.cli.core.sdk.policies:     'Expires': '-1'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-request-id': 'a710fa6e-f035-4761-8c61-7e68352a7c2d'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-correlation-request-id': '2a4174e1-7b4c-40f6-8f1d-cb79c838068c'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-arm-service-request-id': '50b5606e-9e66-435e-a50d-fec19db1c8cb'
DEBUG: cli.azure.cli.core.sdk.policies:     'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
DEBUG: cli.azure.cli.core.sdk.policies:     'Server': 'Microsoft-HTTPAPI/2.0, Microsoft-HTTPAPI/2.0'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-ratelimit-remaining-subscription-writes': '1199'
DEBUG: cli.azure.cli.core.sdk.policies:     'x-ms-routing-request-id': 'USGOVVIRGINIA:20240416T053924Z:2a4174e1-7b4c-40f6-8f1d-cb79c838068c'
DEBUG: cli.azure.cli.core.sdk.policies:     'X-Content-Type-Options': 'nosniff'
DEBUG: cli.azure.cli.core.sdk.policies:     'Date': 'Tue, 16 Apr 2024 05:39:23 GMT'
DEBUG: cli.azure.cli.core.sdk.policies: Response content:
DEBUG: cli.azure.cli.core.sdk.policies: {"error":{"code":"InvalidResourceReference","message":"Resource 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet referenced by 
resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make sure that the 
referenced resource exists, and that both resources are in the same region.","details":[]}}
DEBUG: cli.azure.cli.core.azclierror: Traceback (most recent call last):
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\knack/cli.py", line 233, in invoke
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/commands/__init__.py", line 664, in execute
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/commands/__init__.py", line 731, in _run_jobs_serially
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/commands/__init__.py", line 712, in _run_job
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/commands/__init__.py", line 1048, in __call__
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/commands/__init__.py", line 1035, in __call__
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/aaz/_poller.py", line 108, in result
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/core/tracing/decorator.py", line 76, in wrapper_use_tracer
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/aaz/_poller.py", line 130, in wait
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/aaz/_poller.py", line 83, in _start
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure\cli\command_modules\network\aaz_compact\latest\network\nic\__cmds.py", line 2404, in _execute_operations
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure\cli\command_modules\network\aaz_compact\latest\network\nic\__cmds.py", line 2444, in __call__
  File "D:\a\_work\1\s\build_scripts\windows\artifacts\cli\Lib\site-packages\azure/cli/core/aaz/_operation.py", line 332, in on_error
azure.core.exceptions.HttpResponseError: (InvalidResourceReference) Resource 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet referenced by 
resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make sure that the 
referenced resource exists, and that both resources are in the same region.
Code: InvalidResourceReference
Message: Resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet 
referenced by resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make 
sure that the referenced resource exists, and that both resources are in the same region.
ERROR: cli.azure.cli.core.azclierror: (InvalidResourceReference) Resource 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet referenced by 
resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make sure that the 
referenced resource exists, and that both resources are in the same region.
Code: InvalidResourceReference
Message: Resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet 
referenced by resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make 
sure that the referenced resource exists, and that both resources are in the same region.
ERROR: az_command_data_logger: (InvalidResourceReference) Resource 
/subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet referenced by 
resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make sure that the 
referenced resource exists, and that both resources are in the same region.
Code: InvalidResourceReference
Message: Resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/virtualNetworks/az-opa-dev-usva-vnet/subnets/AppSubnet 
referenced by resource /subscriptions/91da15f8-3ba9-4916-afe1-da3b8651e6d5/resourceGroups/az-ha-dev-usva-rg/providers/Microsoft.Network/networkInterfaces/hadr-nic was not found. Please make 
sure that the referenced resource exists, and that both resources are in the same region.
DEBUG: cli.knack.cli: Event: Cli.PostExecute [<function AzCliLogging.deinit_cmd_metadata_logging at 0x04753898>]
INFO: az_command_data_logger: exit code: 1
INFO: cli.__main__: Command ran in 6.054 seconds (init: 1.403, invoke: 4.651)
INFO: telemetry.main: Begin splitting cli events and extra events, total events: 1
INFO: telemetry.client: Accumulated 0 events. Flush the clients.
INFO: telemetry.main: Finish splitting cli events and extra events, cli events: 1
INFO: telemetry.save: Save telemetry record of length 4803 in cache
INFO: telemetry.main: Begin creating telemetry upload process.
INFO: telemetry.process: Creating upload process: "C:\Program Files (x86)\Microsoft SDKs\Azure\CLI2\python.exe C:\Program Files (x86)\Microsoft 
SDKs\Azure\CLI2\Lib\site-packages\azure\cli\telemetry\__init__.pyc C:\Users\fongwaacha\.azure"
INFO: telemetry.process: Return from creating process
INFO: telemetry.main: Finish creating telemetry upload process.




VNetresourceGroupName="your_resource_group_name"
virtualNetworkName="your_virtual_network_name"

# Retrieve the virtual network
vnet=$(az network vnet show --resource-group $resourceGroupName --name $virtualNetworkName)
vnetName=$(echo $vnet | jq -r '.name')
